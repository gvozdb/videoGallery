Класс Василия Наумкина - https://gist.github.com/bezumkin/4243590
Пришлось его чуточку поправить.
